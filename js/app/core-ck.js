/**
 * Core file for Legislature tracker.
 *
 * Namespaces LT and allows for no conflict function.
 */var LT,originalLT,exports=exports||undefined;if(!_.isUndefined(exports))LT=exports;else{originalLT=window.LT;LT={};LT.noConflict=function(){window.LT=originalLT;return this};window.LT=LT}(function(e,t,n){LT.cache={};LT.cache.models={};LT.log=function(e){_.isUndefined(window.console)||window.console.log(e)};LT.utils={};LT.utils.getModel=function(e,t,n,r){var i=e+":"+t+":"+n[t];r=r||LT.options;_.isUndefined(LT.cache.models[i])&&(LT.cache.models[i]=new LT[e](n,r));return LT.cache.models[i]};LT.utils.fetchModel=function(t){var n;if(t.get("fetched")!==!0)return t.fetch();n=e.Deferred();n.resolveWith(t);return n};LT.utils.translate=function(e,t){var n=t;_.isObject(LT.options.wordTranslations[e])&&_.isString(LT.options.wordTranslations[e][t])&&(n=LT.options.wordTranslations[e][t]);return n};LT.utils.imagePath=function(e){return e.indexOf("http")===0?e:LT.options.imagePath+e};LT.templates=LT.templates||{};LT.utils.getTemplate=function(t,n,r,i){var s="js/app/templates/"+t+".html",o=LT.options.templatePath+t+".html";_.isUndefined(LT.templates[s])?e.ajax({url:o,method:"GET",async:!1,contentType:"text",success:function(e){LT.templates[s]=_.template(e);n[r]=LT.templates[s];_.isFunction(i)&&i.apply(this,[e])}}):n[r]=LT.templates[s]};LT.parse=LT.parse||{};LT.parse.eData=function(e){var t={};t.categories=LT.parse.eCategories(e.sheets("Categories").all());var n=e.sheets("Bills").all();n.length>LT.options.maxBills&&LT.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker.");t.bills=LT.parse.eBills(n.slice(0,LT.options.maxBills));t.events=LT.parse.eEvents(e.sheets("Events").all());_.each(_.groupBy(t.events,"bill_id"),function(e,n){_.each(t.bills,function(r,i){r.bill===n&&(t.bills[i].custom_events=e)})});return t};LT.parse.validateBillNumber=function(e){return LT.options.billNumberFormat.test(e)};LT.parse.eBills=function(e){return _.map(e,function(e){LT.parse.translateFields(LT.options.fieldTranslations.eBills,e);e.links=LT.parse.eLinks(e.links);e.categories=e.categories?e.categories.split(","):[];e.categories=_.map(e.categories,_.trim);e.bill_primary=n;e.bill&&LT.parse.validateBillNumber(e.bill)?e.bill_primary=LT.utils.getModel("OSBillModel","bill_id",{bill_id:_.trim(e.bill)}):e.bill&&!LT.parse.validateBillNumber(e.bill)&&LT.log('Invalid primary bill number "'+e.bill+'" for row '+e.rowNumber+", see documentation.");e.bill_companion&&LT.parse.validateBillNumber(e.bill_companion)?e.bill_companion=LT.utils.getModel("OSBillModel","bill_id",{bill_id:_.trim(e.bill_companion)}):e.bill_companion&&!LT.parse.validateBillNumber(e.bill_companion)&&LT.log('Invalid companion bill number "'+e.bill_companion+'" for row '+e.rowNumber+", see documentation.");e.bill_conference&&LT.parse.validateBillNumber(e.bill_conference)?e.bill_conference=LT.utils.getModel("OSBillModel","bill_id",{bill_id:_.trim(e.bill_conference)}):e.bill_conference&&!LT.parse.validateBillNumber(e.bill_conference)&&LT.log('Invalid conference bill number "'+e.bill_conference+'" for row '+e.rowNumber+", see documentation.");e.hasBill=!0;if(!e.bill||e.bill_primary===n){e.hasBill=!1;e.bill=_.cssClass(e.title.toLowerCase())}return e})};LT.parse.eCategories=function(e){return _.map(e,function(e){LT.parse.translateFields(LT.options.fieldTranslations.eCategories,e);e.links=LT.parse.eLinks(e.links);return e})};LT.parse.eEvents=function(e){return _.map(e,function(e){LT.parse.translateFields(LT.options.fieldTranslations.eEvents,e);e.links=LT.parse.eLinks(e.links);e.date=moment(e.date);e.type=["custom"];return e})};LT.parse.eLinks=function(e){var t=[];e=_.trim(e);if(e.length===0)return t;e=e.substring(0,1)==='"'?e.substring(1):e;e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e;t=e.split('", "');t=_.map(t,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}});return t};LT.parse.csvCategories=function(e){e=_.trim(e);if(e.length===0)return[];e=e.substring(0,1)==='"'?e.substring(1):e;e=e.substring(e.length-1,e.length)==='"'?e.slice(0,-1):e;return e.split('", "')};LT.parse.detectCompanionBill=function(e){var t,r;if(_.isFunction(LT.options.detectCompanionBill)){t=LT.options.detectCompanionBill(e);r=LT.parse.validateBillNumber(t)?t:n}else if(_.isRegExp(LT.options.detectCompanionBill)){t=LT.options.detectCompanionBill.exec(e);r=t&&LT.parse.validateBillNumber(t[1])?t[1]:n}return _.trim(r)};LT.parse.translateFields=function(e,t){_.each(e,function(e,n){t[n]=t[e];n!==e&&delete t[e]});return t};LT.defaultOptions={sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:100,substituteMatch:/substituted/i,imagePath:"./css/images/",templatePath:"./js/app/templates/",recentChangeThreshold:7,tabletopOptions:{},scrollOffset:!1,conferenceBill:!0,recentImage:"RecentUpdatedBill.png",chamberLabel:!1,detectCompanionBill:/([A-Z]+ [1-9][0-9]*)$/,billNumberFormat:/[A-Z]+ [1-9][0-9]*/,osBillParse:!1}})(jQuery,window);