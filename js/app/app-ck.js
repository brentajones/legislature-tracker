/**
 * Main application container for the Legislature Tracker
 *
 * An 'e' prefix is referring to editorialized content.
 */(function(e,t,n){LT.Application=Backbone.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","bill-detail/:bill":"routeOSBill","*defaultR":"routeDefault"},initialize:function(e){LT.options=_.extend(LT.defaultOptions,e);LT.app=this;_.bindAll(this);this.mainView=new LT.MainApplicationView(LT.options);this.mainView.router=this;this.mainView.loading();this.tabletop=Tabletop.init(_.extend(LT.options.tabletopOptions,{key:LT.options.eKey,callback:this.loadEBills,callbackContext:this,wanted:LT.options.sheetsWanted}))},loadEBills:function(t,n){var r=this,i=LT.parse.eData(n);this.categories=new LT.CategoriesCollection(null);this.bills=new LT.BillsCollection(null);_.each(i.bills,function(e){r.bills.add(LT.utils.getModel("BillModel","bill",e))});_.each(i.categories,function(e){r.categories.add(LT.utils.getModel("CategoryModel","id",e))});this.bills.each(function(e){e.loadCategories()});LT.options.aggregateURL?e.jsonp({url:LT.options.aggregateURL,success:this.loadAggregateCounts}):this.start()},loadAggregateCounts:function(e){var t=this;_.each(e,function(e){e.stat==="total-bills"&&(t.totalBills=parseInt(e.value,10));e.stat==="total-bills-passed"&&(t.totalBillsPassed=parseInt(e.value,10));e.stat==="total-bills-signed"&&(t.totalBillsSigned=parseInt(e.value,10))});this.start()},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0});this.mainView.render()},routeCategories:function(){var e=this;this.mainView.loading();this.getOSBasicBills(function(){e.makeRecentCategory();e.mainView.renderCategories()},this.error)},routeCategory:function(e){var t=this;e=decodeURI(e);e=this.categories.get(e);this.mainView.loading();e.loadBills(function(){t.mainView.renderCategory(e)},t.error)},routeRecentCategory:function(){var e=this;this.mainView.loading();this.getOSBasicBills(function(){e.makeRecentCategory();var t=e.categories.get("recent");t.loadBills(function(){e.mainView.renderCategory(t)},e.error)},this.error)},routeEBill:function(e){var t=this,n=decodeURI(e);e=this.bills.where({bill:n})[0];if(!e){this.navigate("/bill-detail/"+encodeURI(n),{trigger:!0,replace:!0});return}this.mainView.loading();e.loadOSBills().done(function(){e.loadOSCompanion().done(function(){e.parseMeta();t.mainView.renderEBill(e)})}).fail(t.error)},routeOSBill:function(t){var n=this;t=decodeURI(t);t=LT.utils.getModel("OSBillModel","bill_id",{bill_id:t});this.mainView.loading();e.when.apply(e,[LT.utils.fetchModel(t)]).done(function(){n.mainView.renderOSBill(t)}).fail(n.error)},makeRecentCategory:function(){if(!this.madeRecentCategory){var e={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+LT.options.recentChangeThreshold+" days.",image:LT.options.recentImage};this.bills.each(function(t){var n=t.get("categories"),r=t.get("hasBill");if(r===!0&&Math.abs(parseInt(t.lastUpdatedAt().diff(moment(),"days"),10))<LT.options.recentChangeThreshold){n.push(e.id);t.set("categories",n)}});this.categories.add(LT.utils.getModel("CategoryModel","id",e));this.bills.each(function(e){e.loadCategories()});this.madeRecentCategory=!0}},getOSBasicBills:function(t,n){var r=this,i=[];if(!this.fetchedCategories){this.bills.each(function(e){_.each(["bill_primary","bill_companion","bill_conference"],function(t){e.get(t)&&i.push(e.get(t).get("bill_id"))})});var s="http://openstates.org/api/v1/bills/?state="+LT.options.state+"&search_window=session:"+LT.options.session+"&bill_id__in="+encodeURI(i.join("|"))+"&apikey="+LT.options.OSKey+"&callback=?";e.jsonp({url:s,success:function(e){r.fetchedCategories=!0;_.each(e,function(e){e.created_at=moment(e.created_at);e.updated_at=moment(e.updated_at);LT.utils.getModel("OSBillModel","bill_id",e).set(e)});t.call(r)},error:this.error})}else t.call(r)},error:function(e){this.mainView.error(e)}})})(jQuery,window);