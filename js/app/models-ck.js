/**
 * Models for the Legislature Tracker app.
 */(function(e,t,n){LT.OSModel=Backbone.Model.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(LT.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(e,t){this.options=t;this.on("sync",function(e,t){e.set("fetched",!0)})}});LT.OSStateModel=LT.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}});LT.OSBillModel=LT.OSModel.extend({url:function(){return _.isUndefined(this.id)?this.urlBase()+"bills/"+encodeURI(this.options.state)+"/"+encodeURI(this.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(e,t){LT.OSBillModel.__super__.initialize.apply(this,arguments);this.on("sync",function(e,t,n){this.parseOSData()})},parseOSData:function(){var e;this.set("created_at",moment(this.get("created_at")));this.set("updated_at",moment(this.get("updated_at")));e=this.get("action_dates");_.each(e,function(t,n){e[n]=t?moment(t):t});this.set("action_dates",e);e=this.get("actions");_.each(e,function(t,n){e[n].date=t.date?moment(t.date):t.date});this.set("actions",e);e=this.get("votes");_.each(e,function(t,n){e[n].date=t.date?moment(t.date):t.date});this.set("votes",e);e=this.get("custom_events");_.isArray(e)&&e.length>0&&this.set("actions",_.union(this.get("actions"),e));this.set("actions",_.sortBy(this.get("actions"),function(e,t){return(e.date.unix()+t)*-1}));this.set("newest_action",this.get("actions")[0]);LT.options.osBillParse&&_.isFunction(LT.options.osBillParse)&&LT.options.osBillParse(this)},getActionDate:function(e){return this.get("action_dates")[e]?this.get("action_dates")[e]:!1},isSubstituted:function(){var e=!1;if(_.isBoolean(this.get("substitued")))e=this.get("substitued");else if(LT.options.substituteMatch===!1)e=!1;else{e=_.find(this.get("actions"),function(e){return e.action.match(LT.options.substituteMatch)});e=e?!0:!1;this.set("substitued",e)}return e}});LT.OSLegislatorModel=LT.OSModel.extend({osType:"legislators"});LT.OSCommitteeModel=LT.OSModel.extend({osType:"committees"});LT.BillModel=Backbone.Model.extend({initialize:function(e,t){this.options=t},loadOSBills:function(t,n){var r=this,i=[];_.each(["bill_primary","bill_companion","bill_conference"],function(e){r.get("hasBill")&&r.get(e)&&i.push(LT.utils.fetchModel(r.get(e)))});return e.when.apply(e,i)},loadOSCompanion:function(){var t=this,n,r=[];if(this.get("hasBill")===!0&&!this.get("bill_companion")&&_.isObject(this.get("bill_primary"))&&_.isArray(this.get("bill_primary").get("companions"))&&_.isObject(this.get("bill_primary").get("companions")[0])){n=LT.parse.detectCompanionBill(this.get("bill_primary").get("companions")[0].bill_id);if(n){this.set("bill_companion",LT.utils.getModel("OSBillModel","bill_id",{bill_id:n}));r.push(LT.utils.fetchModel(this.get("bill_companion")))}}return e.when.apply(e,r)},loadCategories:function(){this.get("categories")&&this.set("categories",_.map(this.get("categories"),function(e){_.isObject(e)||(e=LT.utils.getModel("CategoryModel","id",{id:e}));return e}))},lastUpdatedAt:function(){var e,t=this.get("bill_primary"),n=this.get("bill_companion"),r=this.get("bill_conference");if(_.isUndefined(this.get("last_updated_at"))&&t.get("updated_at")){e=t.get("updated_at");n&&n.get("updated_at")&&(e=n.get("updated_at").unix()>e.unix()?n.get("updated_at"):e);r&&r.get("updated_at")&&(e=r.get("updated_at").unix()>e.unix()?r.get("updated_at"):e);this.set("last_updated_at",e)}else _.isUndefined(this.get("last_updated_at"))&&!t.get("updated_at")&&LT.log("Could not fetch primary bill data from OpenStates. Check that the id "+this.get("bill_primary").get("bill_id")+" is formatted properly.");return this.get("last_updated_at")},newestAction:function(){var e,t=this.get("bill_primary"),n=this.get("bill_companion"),r=this.get("bill_conference");if(this.get("hasBill")&&_.isUndefined(this.get("newest_action"))&&t.get("newest_action")){e=t.get("newest_action");n&&n.get("newest_action")&&(e=n.get("newest_action").date.unix()>e.date.unix()?n.get("newest_action"):e);r&&r.get("newest_action")&&(e=r.get("newest_action").date.unix()>e.date.unix()?r.get("newest_action"):e);this.set("newest_action",e)}return this.get("newest_action")},parseMeta:function(){var e={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},t={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};this.get("custom_events")&&this.set("custom_events",_.sortBy(this.get("custom_events"),function(e,t){return(e.date.unix()+t)*-1}));if(this.get("hasBill")){if(t.companion){this.get("bill_companion").isSubstituted()&&(t.substituted=!0);this.get("bill_primary").isSubstituted()&&(t.substituted=!0)}if(!t.companion||t.substituted){e.lower=this.get("bill_primary").getActionDate("passed_lower");e.upper=this.get("bill_primary").getActionDate("passed_upper")}if(t.companion&&!t.substituted)if(this.get("bill_primary").get("chamber")==="upper"){e.upper=this.get("bill_primary").getActionDate("passed_upper");e.lower=this.get("bill_companion").getActionDate("passed_lower")}else{e.lower=this.get("bill_primary").getActionDate("passed_lower");e.upper=this.get("bill_companion").getActionDate("passed_upper")}if(t.conference){var n=this.get("bill_conference").getActionDate("passed_lower"),r=this.get("bill_conference").getActionDate("passed_upper");n&&r&&(e.conference=n.unix()>=r.unix()?n:r)}t.conference?e.signed=this.get("bill_conference").getActionDate("signed"):e.signed=this.get("bill_primary").getActionDate("signed");t.conference?e.last=this.get("bill_conference").getActionDate("last"):t.companion?e.last=this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):e.last=this.get("bill_primary").getActionDate("last");this.get("description")||this.set("description",this.get("bill_primary").get("summary"))}this.set("actions",e);this.set("bill_type",t);return this}});LT.CategoryModel=Backbone.Model.extend({initialize:function(e,t){this.options=t;this.set("bills",new LT.BillsCollection(null));this.getBills()},getBills:function(){var e=this,t=LT.app.bills,n=this.get("id");t.each(function(t){_.indexOf(t.get("categories"),n)!==-1&&e.get("bills").push(LT.utils.getModel("BillModel","bill",t.attributes))});return this},loadBills:function(t,n){var r=[],i=this;this.get("bills").each(function(e){r.push(e.loadOSBills())});e.when.apply(e,r).done(function(){var r=[];i.get("bills").each(function(e){r.push(e.loadOSCompanion())});e.when.apply(e,r).done(function(){i.get("bills").each(function(e){e.parseMeta()});t()}).fail(n)}).fail(n);return this}})})(jQuery,window);